{% extends 'base.html' %}

{%block title %} Loan Emi {%endblock%}
{%block body %}
<div class="calculator-container pt-2">
  <h4 class="mt-2"><strong>Loan EMI Calculator</strong></h4>
  <div class="row">
    <div class="col-md-7 d-flex border p-3" style="width: 43rem;">
      <form action="/emi" method="post" class="feild_mrg col-sm-8">
        <!-- <div class="form-group row">
          <label for="loan-type" class="col-sm-5 col-form-label">Select Loan Type:</label>
          <div class="col-sm-7">
            <select id="loan-type" name="loan_type" class="form-control" required>
              <option value="car">Car Loan</option>
              <option value="home">Home Loan</option>
            </select>
          </div>
        </div> -->
        <div class="form-group row">
          <label for="loan-amount1" class="col-sm-5 col-form-label">Loan Amount (₹):</label>
          <div class="col-sm-7">
            <input type="number" id="loan-amount1" name="loan_amount" class="form-control"
              value="{% if Formdetails %}{{ Formdetails.Total_item_amt }}{% else %}100000{% endif %}" required>
          </div>
        </div>
        <div class="form-group row">
          <label for="down-payment1" class="col-sm-5 col-form-label">Down Payment (₹):</label>
          <div class="col-sm-7">
            <input type="number" id="down-payment1" name="down_payment" class="form-control"
              value="{% if Formdetails %}{{ Formdetails.down_payment }}{% else %}0{% endif %}" required>
          </div>
        </div>
        <div class="form-group row">
          <label for="interest-rate1" class="col-sm-5 col-form-label">Interest Rate (p.a.):</label>
          <div class="col-sm-7">
            <input type="number" id="interest-rate1" name="interest_rate" step="0.01"
              value="{% if Formdetails %}{{ Formdetails.interest_rate }}{% else %}7{% endif %}" class="form-control"
              required>
          </div>
        </div>
        <div class="form-group row">
          <label for="loan-tenure1" class="col-sm-5 col-form-label">Loan Tenure (years):</label>
          <div class="col-sm-7">
            <input type="number" id="loan-tenure1" name="loan_tenure" class="form-control"
              value="{% if Formdetails %}{{ Formdetails.loan_tenure }}{% else %}1{% endif %}" required>
          </div>
        </div>
        <div class="form-group row justify-content-center">
          <div class="col-sm-12 text-center mt-3">
            <button type="submit" class="btn btn-primary mb-2">Calculate</button>
          </div>
        </div>
      </form>
      <div class="card col-sm-4 m-2">
        <div class="card-body d-flex flex-column align-items-center justify-content-center"
          style="height: 100%; text-align: center;">
          <h5 class="card-title"><strong>Equated Monthly Installments (EMI)</strong></h5>
          <p class="card-text" style="color: #d6286e; font-size: x-large;">₹{% if BreakUp %}{{BreakUp.first_month}}{% else %}8,653{% endif %}</p>
          <h5 class="card-title"><strong>Daily Amount</strong></h5>
          <p class="card-text" style="color: #d6286e; font-size: x-large;">₹{% if BreakUp %}{{BreakUp.daily_amount}}{% else %}284.47{% endif %}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 ms-4" style="width: fit-content;">
      <h4><strong>Break-Up of </strong>Total Payment</h4>
      <div class="border">
        <div class="p-3 d-flex justify-content-center">
          <canvas id="myChart" width="600" height="400"></canvas>
        </div>
        <div class="border-bottom p-2 d-flex justify-content-between">
          <div>
            <div class="legend-box ms-3" style="background-color: #d6286e;"></div>
            Principal Amt
          </div>
          <span style="color: #d6286e;margin-right: 15px">₹ {% if BreakUp %}{{BreakUp['total_principal_repaid']}}{% else %}1,00,000{% endif %}</span>
        </div>
        <div class="border-bottom p-2 d-flex justify-content-between">
          <div>
            <div class="legend-box ms-3" style="background-color: #999999;"></div>
            Interest Amt
          </div>
          <span style="color: #212529;margin-right: 15px">₹ {% if BreakUp %}{{BreakUp['total_interest_repaid']}}{% else %}3,832{% endif %}</span>
        </div>
        <div class="p-2 d-flex justify-content-between">
          <div>
            <div class="legend-box ms-3"></div>
            Total Amt Payable
          </div>
          <span style="color: #212529;margin-right: 15px">₹ {% if BreakUp %}{{BreakUp.payable_amt}}{% else %}1,03,832{% endif %}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container mt-3">
  <div class="row">
    <div class="col text-center">
      <h3>Loan Repayment Summary</h3>
    </div>
    <div class="col-auto">
      <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#loanDurationModal" aria-label="View Loan Duration Details">View Loan Duration Details</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="loanDurationModal" tabindex="-1" aria-labelledby="loanDurationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loanDurationModalLabel">Loan Duration Summary</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Total Months:</strong> {% if BreakUp %}{{BreakUp.Total_months}}{% else %}12{% endif %} months</p>
          <p><strong>Total Days:</strong> {% if BreakUp %}{{BreakUp.No_days}}{% else %}365{% endif %} days</p>
          <p><strong>Total Years:</strong> {% if BreakUp %}{{BreakUp.Tenure}}{% else %}1{% endif %} year</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% if Yearly %}
<table class="table table-secondary table-hover">
  <thead>
    <tr>
      <th>Year</th>
      <th>Opening Balance</th>
      <th>Interest Paid during the Year</th>
      <th>Principal Repaid during the Year</th>
      <th>Closing Balance</th>
    </tr>
  </thead>
  <tbody>
    {% for year in Yearly %}
    <tr class="toggle" onclick="toggleSubTable(`sub-{{ year['Opening Balance'] }}`)">
      <td>{{ year.Year }}</td>
      <td>₹{{ year['Opening Balance'] }}</td>
      <td>₹{{ year['Interest Paid During Year'] }}</td>
      <td>₹{{ year['Principal Repaid During Year'] }}</td>
      <td>₹{{ year['Closing Balance'] }}</td>
    </tr>
    <tr id="sub-{{ year['Opening Balance'] }}" class="sub-table">
      <td colspan="5">
        <p class="text-success"><strong>Monthly Details for Year {{ year.Year }}</strong></p>
        <table class="table table-light table table-hover" style="margin-top: 20px;">
          <thead>
            <tr>
              <th>Month</th>
              <th>(PA) Principal Amount</th>
              <th>(I) Interest for Month (PA*I)</th>
              <th>(PC) Principal Component <i>(EMI - I)</i></th>
              <th>Total Amount (PA + I)</th>
              <th>Remaining Principal (PA-PC)</th>
            </tr>
          </thead>
          <tbody>
            {% for month in year['Monthly Amount'] %}
            <tr>
              <td>{{ month['Month'] }}</td>
              <td>₹{{ month['principal_Amount'] }}</td>
              <td>₹{{ month['Interest_for_Month'] }}</td>
              <td>₹{{ month['principal_amt_month'] }}</td>
              <td>₹{{ month['Total_amt_Month'] }}</td>
              <td>₹{{ month['Remaining_Principal'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<table class="table table-secondary">
  <thead>
    <tr>
      <th>Year</th>
      <th>Opening Balance</th>
      <th>Interest Paid during the Year</th>
      <th>Principal Repaid during the Year</th>
      <th>Closing Balance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td scope="row">1</td>
      <td>₹1,00,000</td>
      <td>₹3,832</td>
      <td>₹1,00,000</td>
      <td>₹0</td>
    </tr>
  </tbody>
</table>
{% endif %}


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const serverData = [`{% if BreakUp %}{{BreakUp['total_principal_repaid']}}{% else %}100000{% endif %}`, `{% if BreakUp %}{{BreakUp['total_interest_repaid']}}{% else %}3832{% endif %}`];
    const numericData = serverData.map(value => parseInt(value.replace(/,/g, ''), 10));
    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: numericData,
          backgroundColor: ['#d6286e', '#999999'],
          borderWidth: 0
        }]
      },
      options: {
        cutout: '65%',
        responsive: true,
        maintainAspectRatio: false,
        rotation: -90,
        circumference: 180,
      }
    });
  });

  function toggleSubTable(id) {
    const subTable = document.getElementById(id);
    subTable.style.display = subTable.style.display === "table-row" ? "none" : "table-row";
  }
</script>
{%endblock%}




